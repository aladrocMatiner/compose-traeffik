# File: traefik/dynamic/middlewares.yml
#
# Traefik Dynamic Configuration: Middlewares
# This file defines reusable middlewares that can be applied to routers.
#

http:
  middlewares:
    # --- HTTP to HTTPS Redirect Middleware ---
    # This middleware automatically redirects all HTTP traffic to HTTPS.
    # It's applied by default to the 'web' entrypoint via traefik/traefik.yml.
    # Its behavior can be controlled by the HTTP_TO_HTTPS_REDIRECT environment variable.
    redirect-to-https:
      redirectScheme:
        scheme: https
        permanent: true # Use 301 Permanent Redirect
        # Only activate if HTTP_TO_HTTPS_REDIRECT is 'true'
        # Traefik doesn't have direct if conditions in middlewares,
        # so this middleware is always defined but its application is conditional
        # via Traefik's dynamic router rules (or entrypoint config in static).
        # We handle the toggle for the 'web' entrypoint dynamically in traefik.yml,
        # but for individual routers, they would explicitly call this.
        # The entrypoint rule `middlewares: ["redirect-to-https@file"]` will always apply
        # to the 'web' entrypoint. If HTTP_TO_HTTPS_REDIRECT is false, users should
        # remove this middleware from their routers/entrypoint config.
        # For simplicity of global control, we will toggle the ENTRYPOINT itself,
        # making the middleware always present.
        # However, to meet the spec: "Redirect middleware can be enabled/disabled by documented toggle (env or config)"
        # I will adjust traefik.yml to conditionally apply this middleware to the entrypoint.

    # --- Security Headers Middleware ---
    # This middleware adds common security headers to responses.
    security-headers:
      headers:
        sslRedirect: true # Force HTTP to HTTPS redirection (though also handled by redirect-to-https)
        browserXssFilter: true
        contentTypeNosniff: true
        forceTextHtml: false
        # The following headers are added if not already present
        customResponseHeaders:
          X-Frame-Options: "DENY"
          X-XSS-Protection: "1; mode=block"
          X-Content-Type-Options: "nosniff"
          Referrer-Policy: "strict-origin-when-cross-origin"
          Strict-Transport-Security: "max-age=31536000; includeSubDomains; preload"
        # Content-Security-Policy: "default-src 'self' https:; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';"
        # You may need to customize Content-Security-Policy based on your application needs.
