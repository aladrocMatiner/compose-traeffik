# Mode A: Local self-signed TLS

## Overview

Mode A uses a local self-signed CA and leaf certificate generated by the repo script. Traefik serves these files from its file-based TLS configuration.

## Prerequisites

- Docker and Docker Compose
- `make`
- `openssl`
- A configured `.env` file

## Steps

1. **Create your env file**
   ```bash
   cp .env.example .env
   ```

2. **Set required values in `.env`**
   - `DEV_DOMAIN`
   - `BASE_DOMAIN`
   - `LOOPBACK_X`
   - `ENDPOINTS`

3. **Generate local certificates**
   ```bash
   make certs-local
   ```

4. **Map local subdomains to loopback**
   ```bash
   sudo make hosts-apply
   ```

5. **Start the stack**
   ```bash
   make up
   ```

6. **Run smoke tests**
   ```bash
   make test
   ```

## Expected result

- Traefik serves HTTPS using the files in `shared/certs/local/`.
- `https://whoami.${DEV_DOMAIN}` responds over HTTPS.
- Smoke tests pass.

## Verification

```bash
curl -vk "https://whoami.${DEV_DOMAIN}/"
openssl s_client -connect "whoami.${DEV_DOMAIN}:443" -servername "whoami.${DEV_DOMAIN}" \
  -CAfile shared/certs/local-ca/ca.crt -verify_return_error -prexit
```

## Renewal / rotation

- Re-run `make certs-local` to regenerate the CA and leaf certs.
- Restart Traefik (`make up`) if you want to ensure it reloads the files.

## Rollback to Mode A

Mode A is the default. To return from other modes:
- Set `TLS_CERT_RESOLVER=` in `.env`.
- Stop profile-specific services (`make stepca-down`, `make dns-down`) if needed.
- Re-run `make certs-local` and `make up`.

## Common pitfalls

- **Browser warning about the certificate**: trust the CA at `shared/certs/local-ca/ca.crt`.
- **Hostnames do not resolve**: run `sudo make hosts-apply` or configure DNS.
- **Ports 80/443 already in use**: stop conflicting services before `make up`.

## Troubleshooting

- `make logs` to inspect Traefik output.
- `make test` to confirm routing and TLS handshake.
- `openssl s_client` output shows which certificate is served.

## Related

- [Root README](../README.md)
- [Mode B: Let's Encrypt + Certbot](tls-mode-b-letsencrypt-certbot.md)
- [Mode C: Step-CA ACME](tls-mode-c-stepca-acme.md)
