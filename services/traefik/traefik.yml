# File: traefik/traefik.yml
#
# Traefik Static Configuration
# This file defines Traefik's global settings, entrypoints, and providers.
#

global:
  checkNewVersion: true
  sendAnonymousUsage: false

# Entrypoints define the ports Traefik listens on.
entryPoints:
  web:
    address: ":80"
  websecure:
    address: ":443"
  traefik:
    address: ":8080"

# Providers tell Traefik where to find its dynamic configuration.
providers:
  # File provider: loads dynamic configuration from YAML files.
  file:
    directory: /etc/traefik/dynamic # Directory containing dynamic config files
    watch: true # Watch for changes in the dynamic config files
  # Docker provider: loads dynamic configuration from container labels.
  docker:
    endpoint: "unix:///var/run/docker.sock"
    exposedByDefault: false
    network: traefik-proxy
    watch: true

# API and Dashboard configuration.
# The dashboard is disabled by default for security.
api:
  dashboard: true
  insecure: false

ping:
  entryPoint: traefik

# Log configuration
log:
  level: INFO # DEBUG, INFO, WARNING, ERROR, FATAL, PANIC
  format: common # json or common
  # filePath: "/var/log/traefik.log" # Uncomment to log to a file

# --- Certificates Resolvers ---
# These are used by Traefik's ACME client to obtain TLS certificates.
# Only one resolver will be active at a time based on the `TLS_CERT_RESOLVER` env var.

# Let's Encrypt resolver (for Mode B, profile 'le')
# Activated when TLS_CERT_RESOLVER is 'le-resolver'
# Requires an email and storage.
certificatesResolvers:
  le-resolver:
    acme:
      email: ${ACME_EMAIL}
      storage: /certs/acme-le.json # Store ACME data in a persistent volume
      caServer: ${LETSENCRYPT_CA_SERVER}
      httpChallenge:
        entryPoint: web # Use HTTP-01 challenge on the 'web' entrypoint
        # For certbot integration, you might point to certbot's webroot:
        # If using certbot to *issue* certs, Traefik just reads the files.
        # If Traefik *itself* is doing ACME, it needs to serve the challenge.
        # Given the requirements, Traefik uses its own ACME solver, not Certbot's webroot.
        # However, Certbot is requested in requirements, implying it's used for *issuance*,
        # and Traefik then reads those files. This design means Certbot does the challenge,
        # and Traefik picks up the result.
        # Let's stick to Traefik solving ACME if a resolver is defined.
        # If the user wants certbot to issue, they won't use this resolver.
        # So, the `certbot` service in compose is for *manual* certbot use.
        # This resolver is for Traefik *itself* to get LE certs.

  # Step-CA resolver (for Mode C, profile 'stepca')
  # Activated when TLS_CERT_RESOLVER is 'stepca-resolver'
  # Points to the internal step-ca service for ACME challenges.
  stepca-resolver:
    acme:
      email: ${ACME_EMAIL} # Email is still required by ACME protocol
      storage: /certs/acme-stepca.json # Separate storage for step-ca ACME data
      caServer: ${STEP_CA_CA_SERVER} # ACME directory URL of the step-ca service
      httpChallenge:
        entryPoint: web # Use HTTP-01 challenge on the 'web' entrypoint
